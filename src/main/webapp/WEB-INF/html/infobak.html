<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人中心</title>
    <!--为了确保适当的绘制和触屏缩放，需要在 <head> 之中添加 viewport 元数据标签-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script scr="common.css"></script>
    <link href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>

<div class="container-fluid">
    <h1></h1>
</div>
<hr style="height:3px;border:none;border-top:3px groove deepskyblue;" />

<div class="container-fluid">
    <div class="row">
        <div class="span2  col-xs-12 col-sm-3 col-md-2">
            <ul class="nav nav-pills nav-stacked">
                <li class="active"><a href="personInfo">个人信息</a></li>
                <li><a href="setMeal">套餐购买</a></li>
                <li><a href="detect">人脸探测</a></li>
                <li><a href="verify">人脸比对</a></li>
                <li><a href="gallery">图库管理</a></li>
                <li><a href="record">使用记录</a></li>
            </ul>
        </div>
        <div class="col-xs-12 col-sm-9 col-md-10">
            个人信息页面
            <table align="" border="0px">
                <tr>
                    <td>姓名</td>
                    <td align="center">${customer.name}</td>
                </tr>
                <tr>
                    <td>邮箱</td>
                    <td align="center">${customer.email}</td>
                </tr>
                <tr>
                    <td>注册时间</td>
                    <td align="center">${customer.regtime?string("yyyy-MM-dd")}</td>

                </tr>
                <tr>
                    <td>状态</td>
                    <td align="center"><#if customer.active gt 0 >已激活
                    </#if>
                        <#if customer.active == 0 >未激活
                        </#if>
                    </td>
                </tr>
                <tr>
                    <td>token</td>
                    <td align="center"><#if customer.token??>SSS</#if></td>
                </tr>

                <#if meal??>
                    <#if meal.enable==1>
                        <#if meal.contype=="date">
                            <tr>
                                <td>套餐类型</td>
                                <td align="center">按天</td><tr>
                        </tr>
                            <tr>
                                <td>购买时间</td>
                                <td align="center">${meal.beginTime?string("yyyy-MM-dd")}</td>
                            </tr>
                            <tr>
                                <td>到期时间</td>
                                <td align="center">${meal.endTime?string("yyyy-MM-dd")}</td>
                            </tr>
                            <tr>
                            <td>套餐剩余</td>
                            <td align="center">${leftDay+"天"}</td>
                            </tr>
                        </#if>
                        <#if meal.contype=="times">
                            <tr>
                                <td>套餐类型</td>
                                <td align="center">按次</td></tr>
                            <tr>
                                <td>总次数</td>
                                <td align="center">${meal.totalTimes+"次"}</td>
                            </tr>
                            <tr>
                                <td>剩余次数</td>
                                <td align="center">${meal.leftTimes+"次"}</td>
                            </tr>
                        </#if>
                    </#if>
                </#if>
            </table>
        </div>
    </div>
</div>

<div class="container-fluid">

    <input type="file" onchange="invokeCompress(this)" id="uploadPicInput">
    <img id="imgShow" src="">
    <img id="imgShow1" src="">
</div>
<script>
//    function dealImage(path, obj, callback){
//        var img = new Image();
//        img.src = path;
//        img.onload = function(){
//            var that = this;
//            // 默认按比例压缩
//            var w = that.width,
//                h = that.height,
//                scale = w / h;
//            w = obj.width || w;
//            h = obj.height || (w / scale);
//            var quality = 0.7;  // 默认图片质量为0.7
//            //生成canvas
//            var canvas = document.createElement('canvas');
//            var ctx = canvas.getContext('2d');
//            // 创建属性节点
//            var anw = document.createAttribute("width");
//            anw.nodeValue = w;
//            var anh = document.createAttribute("height");
//            anh.nodeValue = h;
//            canvas.setAttributeNode(anw);
//            canvas.setAttributeNode(anh);
//            ctx.drawImage(that, 0, 0, w, h);
//            // 图像质量
//            if(obj.quality && obj.quality <= 1 && obj.quality > 0){
//                quality = obj.quality;
//            }
//            // quality值越小，所绘制出的图像越模糊
//            var base64 = canvas.toDataURL('image/jpeg', quality );
//            // 回调函数返回base64的值
//            callback(base64);
//        }
//    }
//


function compress(img, width, height, ratio) {
    var canvas, ctx, img64;

    canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;

    ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    img64 = canvas.toDataURL("image/jpeg", ratio);

    return img64;
}



    function invokeCompress(img) {
        var file = img.files[0];
        if (!file) {
            return false;
        }
        var reader = new FileReader();
        reader.onloadend = function (e) {
            // console.log("成功读取....");
            var imgUrl =e.target.result
            var imgShow=document.getElementById("imgShow")
            imgShow.src = imgUrl

            getImageWidth(imgUrl,function (w,h) {
                console.log({"w":w,"h":h})
//                console.log(imgUrl)
                text=compress(imgShow,w*0.1,h*0.1,1)
                document.getElementById("imgShow1").src=text
                console.log(text)
//                console.log("Blob"+dataURItoBlob(text))


                //上传文件时当前的图片内容是文件,对比的对象可能时文件或者url
                var formData = new FormData();
                // formData.append("n",4);
                formData.append("photo", dataURItoBlob(text));
                img.value = "";
                $.ajax({
                    url: 'detect-face',
                    type: 'POST',
//                    dataType: "json",
                    data: formData,
                    processData: false,
                    contentType: false,
                    async: true,
                    success: function (data) {
                        console.log(data)
                    },
                    error: function (data) {
                        console.log(data)
                    }
                });


            })
            // setPicSize(e.target.result,imgShowDiv,imgShow)
        }
        reader.readAsDataURL(file)
//        compress()
    }


function getImageWidth(url, callback) {
    var img = new Image();
    img.src = url;

    // 如果图片被缓存，则直接返回缓存数据
    if (img.complete) {
        callback(img.width, img.height);
    } else {
        // 完全加载完毕的事件
        img.onload = function () {
            callback(img.width, img.height);
        }
    }

}
function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(',')[1]);
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    console.log([ab])
    return new Blob([ab], {type: mimeString});
}
function LargePicCallBack(picResult) {
        console.log(picResult)
    }
    
</script>
</body>
</html>